ignore:
  - node_modules
  - /apps/docs
  - /apps/server
  - /apps/checker
  - /apps/dashboard
  - /apps/screenshot-service
  - /apps/workflows
  - /packages/integrations
builders:
  install:
    fromImage: oven/bun
    workdir: /app/
    # Copy project
    bind:
      - package.json
      - apps/web/package.json
      - packages/analytics/package.json
      - packages/api/package.json
      - packages/assertions/package.json
      - packages/db/package.json
      - packages/emails/package.json
      - packages/error/package.json
      - packages/header-analysis/package.json
      - packages/notification-discord/package.json
      - packages/notification-emails/package.json
      - packages/notification-ntfy/package.json
      - packages/notification-opsgenie/package.json
      - packages/notification-pagerduty/package.json
      - packages/notification-slack/package.json
      - packages/notification-webhook/package.json
      - packages/react/package.json
      - packages/tinybird/package.json
      - packages/tracker/package.json
      - packages/tsconfig/package.json
      - packages/ui/package.json
      - packages/upstash/package.json
      - packages/utils/package.json
    # Install dependencies
    run: bun install --production --ignore-scripts --frozen-lockfile --verbose
    cache:
      - /root/.bun/install/cache
  build:
    fromImage: oven/bun
    workdir: /app/apps/web
    copy:
      - . /app/
      - fromBuilder: install
        source: /app/node_modules
        target: /app/node_modules
      #  Should set env to production here
    # Compile the TypeScript application
    env:
      NODE_ENV: production
    run: bun build --compile --sourcemap src/index.ts --outfile=app
fromImage: debian:bullseye-slim
copy:
  - fromBuilder: build
    source: /app/apps/web/app
    target: /bin/
    chmod: "555"
expose: 3000
entrypoint: /bin/app